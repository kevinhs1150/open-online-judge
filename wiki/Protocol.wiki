#summary OOJ Network Communication Protocol (Specification)
#labels Phase-Design

= Protocol =
<wiki:toc max_depth="2" /> 

= Functionalities requiring network communication =

    server
        must cover all requirements below
    team
        submission
        clarification
        problem download
        scoreboard update (listen)
        runs result (listen)
    judge
        receive run request (listen)
        return run result
        problem update (listen)
        see clarification (listen)
    admin
        manage account
        manage problems
        manage contest site
        reply clarifications
        global broadcast
        set server property
        see server status(ping, bandwidth test) (implement with other tools)

= Usage instruction =

    Include your own header file and use the function inside to communicate.  The usage of functions should be rather easy and pretty well documented inside the header file, just read before use.
    All transmissions are done in UTF-8.  For the purpose of simplicity, the function will only take wide character argument.  So make sure to handle all strings or at least convert them into wchar_t`* type` before passing it to the library.
    For those who only want to use the library, this is all you need from this documentation.

= Detail - Basis =
    All packets will start with two bytes of fixed binary data.
    The first byte will indicate the packet source, defined as follows:
        server = 0 (the packet comes from server).
        admin = 1, judge = 2, team = 3.
    This byte will be named SR in the following documentation.
    The second byte is a unique identification to identify the purpose of the packet.  This byte will be named ID in the following documentation.
    All communications are done with pure string separated by null character “\0” unless specified explicitly.


= Detail - Protocol definitions and diagrams =
    In the block diagram, <font color=red> red </font> block means binary data.  The SRID column is the first two fixed bytes of data and will be prefixed before almost all messages.
    The <font color=blue> blue </font> block means file transfer via VSFTP (Very Simple File Transfer Protocol) defined also in this document.

==VSFTP Protocol==
|| file size || <font color=red> file content </font> ||
    This is a very, very simple file transfer protocol.  It will be used in the OOJ protocol for file transfer.

==Account Management==
*Login* (SR = depend, ID = 00)
|| <font color=red> SRID </font> || account || password ||
    Whether the login client is team, judge, admin will be determined from SR byte.
  
*Login Confirmation* (SR = 0, ID = 00)
|| <font color=red> SRID </font>  || confirmation ||
    If confirmation byte is 1, the account and password are valid.  If confirmation byte is 0, then the client program should block the user from proceeding.
  
*Logout* (SR = depend, ID = 01)
|| <font color=red> SRID </font>  || account id ||
  
*Logout Confirmation* (SR = 0, ID = 01)
|| <font color=red> SRID </font>  || confirmation ||
    Simply indicate that the server has received the logout request.  This message can be ignored by client.  It is however suggested that the client should handle this reply properly.
  
==Team and Server==
*Team -> Server, submission* (SR = 3, ID = 10)
|| <font color=red> SRID </font> || account id || problem id || coding language ||
|| <font color=blue> source code file </font> ||
    A source file transfer will happen following the submission request. Note that server should wait for the file transfer.
    In reply, server should send a run result notification, with result string telling the team that this problem is being judged.

*Team -> Server, clarification* (SR = 3, ID = 11)
|| <font color=red> SRID </font> || account id ||private || clarification message ||
    The private byte will be enabled by 1 and disabled by 0.  If it is enabled, the clarification will be marked “private” on admin client.  If admin determines that this is a private message, the reply will not be broadcasted.
    In reply, server should send a clarification reply, with result string telling the team that this clarification is still being viewed by administrators.
  
*Team -> Server, problem download* (SR = 3, ID = 12)
|| <font color=red> SRID </font> || account id || problem id ||
    Server should reply with the problem requested instantly.

*Server -> Team, run result* (SR = 0, ID = 10)
|| <font color=red> SRID </font> || run id || result string ||

*Server -> Team, clarification reply* (SR = 0, ID = 11)
|| <font color=red> SRID </font> || clar id || result string ||

*Server -> Team, scoreboard update* (SR = 0, ID = 12)
|| <font color=red> SRID </font> || updated team account id || new account || new accept counts || new time ||
    The second parameter will be “the team needed updating”.  For example, if team 10 solved a problem, its new accept counts and time will be sent to all team clients, with second argument “10”.

*Server -> Team, problem upload* (SR = 0, ID = 13)
|| <font color=red> SRID </font> ||
|| <font color=blue> problem content </font> ||

==Judge and Server==
*Judge -> Server, run result* (SR = 2, ID = 10)
|| <font color=red> SRID </font>  || run id || result string ||
    The judge will not know the submitter.

*Server -> Judge, run request* (SR = 0, ID = 14)
|| <font color=red> SRID </font> || run id || problem id || coding language ||
|| <font color=blue> source code file </font> ||

*Server -> Judge, problem update* (SR = 0, ID = 15)
|| <font color=red> SRID </font> || problem id ||
|| <font color=blue> problem description </font> || <font color=blue> input data </font> || <font color=blue> correct answer </font> ||
    If the problem does not exist, the judge client should add a new problem entry.

== Admin and Server ==
*Admin -> Server, account management* (SR = 1, ID = 10)
|| <font color=red> SRID </font> || operation id || parameters ||
Operation id:
    # add, parameters
        || type || account || password ||
    # delete, parameters
        || account || id ||
    # modify, parameters: no type change allowed
        || account id || new account || new password ||
    # update: no parameter.  Server sends all account information to requested administrator.
  
*Admin -> Server, problem management* (SR = 1, ID = 11)
|| <font color=red> SRID </font> || operation id || problem id || parameters ||
    Operation id:
    # add
        parameters
        || <font color=blue> problem description </font> || <font color=blue> input data </font> || <font color=blue> correct answer </font> ||
    # delete: no parameter
    # modify
        parameters
        || <font color=blue> problem description </font> || <font color=blue> input data </font> || <font color=blue> correct answer </font> ||
    # update: no parameter.  Server sends all problem information to requested administrator.

*Admin -> Server, clarification reply* (SR = 1, ID = 12)
|| <font color=red> SRID </font> || clar id || private || result string ||
    If private byte is set, this message will only be replied to its original requester.  Otherwise, regardless how the requester set its private byte, this message will be broadcasted to all contestants.

*Admin -> Server, global broadcast* (SR = 1, ID = 12)
|| <font color=red> SRID </font> || 0 || 0 || broadcast message ||
    Make use of clarification reply and fix clarification id.  Private status is also fixed to 0 for the message to be globally broadcasted.

*Admin -> Server, property settings* (SR = 1, ID = 13)
|| <font color=red> SRID </font> ||     ||     ||               ||

*Server -> Admin, contest site situation* (SR = 0, ID = 16)
|| <font color=red> SRID </font> ||     ||     ||               ||

*Server -> Admin, clarification request* (SR = 0, ID = 17)
|| <font color=red> SRID </font> || clar id ||private || clarification message ||
    The administrator will not know the clarification requester.  The private byte is set according to how user specify it.

*Server -> Admin, account information* (SR = 0, ID = 18)
|| <font color=red> SRID </font> || account id || account type || account ||

*Server -> Admin, problem information* (SR = 0, ID = 19)
|| <font color=red> SRID </font> || problem id ||
|| <font color=blue> problem description </font> || <font color=blue> input data </font> || <font color=blue> correct answer </font> ||

=Known Problem / Limitation=

    # In administrator client, property setting and status monitoring is not yet defined.
    # Multiple judges may compete on the same run (race condition).  Solution: Mark the run as being judged when one judge takes over that run request.

=Change Log=
_version 0.1_
    Initial version.
_version 0.2_
    Implemented account ID.
    File transfer changed into a tiny protocol.  In the implementation, files will be transferred through another function rather than embedded into original message.
    Added two protocols to back transfer account information and problem information to administrator. (two proto added between admin and server)
  